<!DOCTYPE html>
<html lang="en">
<head>
<title>はじめてのthree.js</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
body {
  color: #aaa;
  font-family:Monospace;
  font-size:13px;
  text-align:center;
  font-weight: bold;

  background-color: #444;
  margin: 0px;
  overflow: hidden;
}

#info {
  color:#ccc;
  position: absolute;
  top: 0px; width: 100%;
  padding: 0px;
}

a {
  color: red;
}
</style>
</head>

<body>
<div id="container"></div>
<div id="info">
  <a href="http://threejs.org" target="_blank">three.js</a>へようこそ<br>
  左ボタンのドラッグ：回転、右ボタンのドラッグ：平行移動、ホイール：ズーム、
</div>

<!-- 以下のライブラリの配置はそのままで構わない -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r83/three.js"></script>
<script src="js/TrackballControls.js"></script>
<script>

// Three.js revision 85 is used.

/* global THREE */

(function() {
  "use strict";
  
  var container;
  var camera, controls, light, scene, renderer;
  var mesh;
  var mesh1;

  let snow = new Array(1000);


  var texture;
  var loader = new THREE.TextureLoader();

  loader.load('images/snowMan.png', function (x) {
    texture = x;
    init();
    animate();
  });

  function init() {

    // (1) シーンの作成 （変更しない）
    scene = new THREE.Scene();			  

    // (2) カメラの作成 （変更しない）
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);
    camera.position.x = 100;
    camera.position.y = 500;
    camera.position.z = 1000;

    // カメラをトラックボールで動かす （変更しない）
    controls = new THREE.TrackballControls(camera);
    controls.addEventListener('change', render);

    // (4) ライティング　平行光線＋環境光（変更しない）
    light = new THREE.DirectionalLight(0xffffff);
    light.position.set(300, 200, 100);
    light.castShadow = true;
    light.shadow.camera.top = 1024;
    light.shadow.camera.bottom = -1024;
    light.shadow.camera.left = -1024;
    light.shadow.camera.right = 1024;
    light.shadow.camera.near = 0;
    light.shadow.camera.far = 1024;
    scene.add(light);

    light = new THREE.AmbientLight(0xaaaaaa);
    scene.add(light);


    // (5)表示する物体の作成
    var geometry, material; 

    // 球体（上）		
    geometry = new THREE.SphereGeometry(50, 32, 32);
    material = new THREE.MeshPhongMaterial({
      // color: 0xffffff
      map: texture
    });

    mesh1 = new THREE.Mesh(geometry, material);
    mesh1.position.x = 0;
    mesh1.position.y = 120;
    mesh1.position.z = 0;
    mesh1.castShadow = true;
    // mesh1.rotation.y = -Math.PI/2;
    scene.add(mesh1);

    geometry = new THREE.SphereGeometry(70, 32, 32);
    material = new THREE.MeshPhongMaterial({
      // map: texture
      color: 0xffffff
    });

    mesh1 = new THREE.Mesh(geometry, material);
    mesh1.position.x = 0;
    mesh1.position.y = 0;
    mesh1.position.z = 0;
    mesh1.castShadow = true;
    scene.add(mesh1);

    // 立体（下）
    geometry = new THREE.BoxGeometry(20, 20, 20);
    material = new THREE.MeshLambertMaterial({
      color: 0xffffff,
      //specular: 0xcccccc,
      //emissive: 0xff00ff,
      // map: texture
    });
    
    // 雪だるま
    for (let i = 0; i < 1000; i++) {
    snow[i] = i;

      snow[i] = new THREE.Mesh(geometry, material);
      let x = Math.random() * 1000 - 500;
      snow[i].position.x = x;
      
      let y = Math.random() * 1000 - 500;
      snow[i].position.y = y;

      let z = Math.random() * 1000 - 500;
      snow[i].position.z = z;

      snow[i].receiveShadow = true;
      snow[i].castShadow = true;

       if(Math.sqrt(x*x + y*y + z*z) < 1000) {
        scene.add(snow[i]);
      }
  }


    //地面（PlaneGeometry）の生成
    var mesh =  new THREE.Mesh(
                      new THREE.PlaneGeometry(1000, 1000, 1, 1),
                      new THREE.MeshLambertMaterial({
                          side: THREE.DoubleSide,
                          color: 0xeeeeee
                      })
                  );                      
    // 影の有効化          
    mesh.receiveShadow = true;
    mesh.rotation.x = -Math.PI/2;
    // シーンオブジェクトに追加 
    // scene.add(mesh);      			  

    var axisHelper = new THREE.AxisHelper(1000); 
    scene.add(axisHelper);

    // scene.fog = new THREE.FogExp2( 0xcccccc, 0.001 );

    // (6)レンダリング （変更しない）
    renderer = new THREE.WebGLRenderer( { antialias: false } );

    //影の有効化（レンダラー）
    renderer.shadowMap.enabled = true;

    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.setClearColor("#222222", 1 );

    container = document.getElementById( 'container' );
    container.appendChild( renderer.domElement );

    window.addEventListener( 'resize', onWindowResize, false );
  }

  // ウインドウサイズを変えたときのアクション（変更しない）
  function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize( window.innerWidth, window.innerHeight );
      controls.handleResize();
      render();
  }

  // アニメーションの実行（無限ループ）
  function animate() {
      requestAnimationFrame(animate); //再帰呼出し
      controls.update();			

      // for(let i = 0; i < 1000; i++){
      //   snow[i] = i;
      //   snow[i].position.y -= 1;
      // }

      // if(snow[i] > 1000) {
      //   y = 1000;
      // }

      render();
  }

  function render() {
      renderer.render(scene, camera);
  }

})();

</script>
</body>
</html>
